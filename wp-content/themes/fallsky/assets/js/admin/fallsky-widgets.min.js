!function(e){"use strict";window.wp=window.wp||{},wp.fallskyWidgets=function(){var i=!1,t=fallskyWidgets.widget_dependency||{},n=fallskyWidgets.widget_json||{},a=[],d=fallskyWidgets.widgets||[];function s(e,i){var t,n,s,o;t=i.find("> .widget-inside > .form, > .widget-inside > form"),n=t.find("> .id_base").val(),-1!==d.indexOf(n)&&(s=t.find(".widget-id").val(),-1===a.indexOf(s)&&(o=function(){i.hasClass("open")?(a.push(s),r(i,n,!1)):setTimeout(o,50)})())}function r(a,d,s){var r=a.find("input.fallsky-color-picker"),l=a.find(".editor-widget-control.item-type-editor"),c=a.find(".item-wrapper.item-type-image"),g=a.find("input[type=number]"),f=a.find(".slider-widget-control");if(g.length&&g.on("change",function(i){var t=parseInt(e(this).val()),n=e(this).attr("min"),a=e(this).attr("max");n&&t<parseInt(n)?e(this).val(n):a&&t>parseInt(a)&&e(this).val(a)}),c.length&&c.each(function(){var i=e(this);i.on("click",".button.choose-media, .media-widget-preview",function(i){i.preventDefault();var t=e(this),n=t.hasClass("media")?"media":"image";if("media"==n&&t.hasClass("media-widget-preview")&&t.children("video").length){var a=t.children("video").get(0);a.paused?a.play():a.pause()}else{var d=t.hasClass("media-widget-preview")?t.siblings("input[type=hidden]"):t.parent().siblings("input[type=hidden]");fallsky_media.open(d.first(),n)}}).on("click",".button.remove-media",function(i){i.preventDefault();var t=e(this),n=t.parent(),a=n.siblings(".media-widget-preview");t.removeClass("not-selected").addClass("selected"),n.siblings("input[type=hidden]").val("").first().trigger("change"),a.html("").append(e("<div>",{class:"placeholder",text:a.attr("data-text-preview")}))}).on("fallsky.media.changed","input.fallsky-widget-item[type=hidden]",function(i,t){if(i.preventDefault(),t&&-1!==["image","video"].indexOf(t.type)){var n=t.type,a=t.sizes?t.sizes.medium?t.sizes.medium.url:t.sizes.thumbnail?t.sizes.thumbnail.url:t.url:t.url,d=e("image"==n?"<img>":"<video>",{class:"attachment-thumb",src:a}),s=e(this),r=s.siblings(".media-widget-preview"),o=s.siblings(".media-widget-buttons"),l=s.siblings("input[type=hidden]");r.html("").append(d),o.children(".button.remove-media").removeClass("selected").addClass("not-selected"),l.length&&l.val(n),s.val(t.id).trigger("change")}})}),r.length&&r.each(function(){var i=e(this);i.wpColorPicker({change:function(e,t){var n=t.color?t.color.toString():"";i.val(n).trigger("change")},clear:function(){i.val(""),e(this).trigger("change")}})}),l.length&&!s&&l.each(function(){!function(t,n){var a,d,s,r=n,o=1e3,l=!1;a=r.find(".editor-textarea-wrap textarea"),s=a.val(),d=function(){r.editor.isDirty()&&(wp.customize&&wp.customize.state&&(wp.customize.state("processing").set(wp.customize.state("processing").get()+1),_.delay(function(){wp.customize.state("processing").set(wp.customize.state("processing").get()-1)},300)),a.val(wp.editor.getContent(t))),l&&s!==a.val()&&(a.trigger("change"),l=!1,s=a.val())},function s(){var c,g,f,u,p,w="fallsky-widget-editor-id",h=tinyMCEPreInit&&tinyMCEPreInit.mceInit&&w in tinyMCEPreInit.mceInit&&window.tinymce,m=tinyMCEPreInit&&tinyMCEPreInit.qtInit&&w in tinyMCEPreInit.qtInit&&quicktags;if(!h||!m)return;if(!a.length)return;if(tinymce.get(t)){var v=window.tinymce.get(t),y=window.QTags.getInstance(t),k=n.find("#wp-"+t+"-wrap");a.val(wp.editor.getContent(t)),v&&v.remove(),y&&y.remove(),k.length&&k.remove()}i||(i=e.extend({},{mce:tinyMCEPreInit.mceInit[w],qt:tinyMCEPreInit.qtInit[w]}));f=e.extend({},i.mce,{selector:"#"+t,body_class:i.mce.body_class.replace(w,t)}),u=e.extend({},i.qt,{id:t});p=e("#tmpl-widget-editor-field").html();p=e(p.replace(/\[\[fallsky-widget-editor-id\]\]/g,t));p.find("textarea").attr("id",t).val(a.val());n.append(p);window.tinymce.init(f);quicktags(u);c=window.tinymce.get(t);if(!c)return;g=function(){e(c.getWin()).on("unload",function(){_.defer(s)})};c.initialized?g():c.on("init",g);r.editorFocused=!1;p.find("textarea").on("keyup change blur",function(){l=!0,c.setDirty(!0),d()});c.on("focus",function(){r.editorFocused=!0});c.on("paste",function(){c.setDirty(!0),d()});c.on("NodeChange",function(){l=!0});c.on("NodeChange",_.debounce(d,o));c.on("blur hide",function(){r.editorFocused=!1,d()});r.editor=c}()}(e(this).find(".editor-textarea-wrap textarea").data("id"),e(this))}),f.length&&f.each(function(){var i=e(this).find(".loader-ui-slider"),t=e(this).find("input").first();i.slider({range:"min",min:i.data("min"),max:i.data("max"),value:i.data("value"),step:i.data("step"),slide:function(e,i){t.val(i.value).trigger("change")}})}),d in t&&d in n){var u=t[d],p=n[d];a.find(".fallsky-widget-item").on("change",function(){var i=e(this).data("fallsky-widget-item-id");i in u&&o(a,u[i],p)}),e.each(u,function(e,i){o(a,i,p)})}}function o(i,t,n){e.each(t,function(t,a){var d=i.find("[data-fallsky-widget-item-id="+a+"]");if(d.length&&n[a]){var s=!0;d=d.closest(".item-wrapper"),e.each(n[a],function(e,t){var n=t.operator||"in",a=i.find("[data-fallsky-widget-item-id="+e+"]"),d=-1!==["radio","checkbox"].indexOf(a.first().attr("type"))?a.filter(":checked").val():a.val();if(a.attr("type")&&-1!==["radio","checkbox"].indexOf(a.attr("type"))&&(d=a.filter(":checked").length?d:""),"in"===n&&-1===t.value.indexOf(d)||"not in"===n&&-1!==t.value.indexOf(d))return s=!1,!1}),s?d.show():d.hide()}})}e(document).on("widget-added",s).on("widget-synced widget-updated",function(e,i){var t;"widgets"===window.pagenow&&(t=i.find("> .widget-inside > .form, > .widget-inside > form").find("> .id_base").val(),-1!==d.indexOf(t)&&r(i,t,!0))}).ready(function(){"widgets"===window.pagenow&&e(".widgets-holder-wrap:not(#available-widgets)").find("div.widget").one("click.toggle-widget-expanded",function(){s(new jQuery.Event("widget-added"),e(this))})})}()}(jQuery);