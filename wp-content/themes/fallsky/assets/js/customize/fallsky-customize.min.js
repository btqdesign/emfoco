!function(e,t){"use strict";t("#customize-theme-controls").addClass("fallsky-customizer-wrapper"),e.fallsky=e.fallsky||{},e.fallsky.controls=e.fallsky.controls||{},e.fallsky.homepage_widgets=e.fallsky.homepage_widgets||{},e.fallsky.homepage_area_settings=fallsky_customize.homepage_area_settings||!1;var n="fallsky_site_layout";function i(){var n=e.settings.settings,i={},a=t.extend({},e.settings.controls,e.fallsky.controls);t.each(a,function(a,o){var s,r,d,l=(s=o.settings,r=Object.keys(s),!!(d="default"in s?"default":!!r.length&&r[0])&&s[d]);l&&n[l]&&n[l].dependency&&t.each(n[l].dependency,function(t,s){var r={control:e.control(a)||o,dependency:n[l].dependency};t in i?i[t].push(r):(i[t]=[r],e(t).bind(function(n){e.trigger("fallsky.change",t)}))})}),e.fallsky.dependency=i}function a(e){var t,n={number:null,id_base:null};return(t=e.match(/^(.+)-(\d+)$/))?(n.id_base=t[1],n.number=parseInt(t[2],10)):n.id_base=e,n}e.bind("fallsky.change",function(n){n in e.fallsky.dependency&&t.each(e.fallsky.dependency[n],function(n,i){var a=i.control.container,o=!0;t.each(i.dependency,function(t,n){var i=n.operator||"in",a=function(t){if(t in e.settings.settings){var n=e.get()[t];return!0===n?"on":n}}(t);if("in"===i&&-1===n.value.indexOf(a)||"not in"===i&&-1!==n.value.indexOf(a))return o=!1,!1}),o?a.show():a.hide()})}),e.controlConstructor.number_slider=e.Control.extend({ready:function(){var e=this.container.find(".loader-ui-slider"),t=this.container.find("input[data-customize-setting-link]");e.slider({range:"min",min:e.data("min"),max:e.data("max"),value:e.data("value"),step:e.data("step"),slide:function(e,n){t.val(n.value).trigger("change")}})}}),e.controlConstructor.number=e.controlConstructor.number_with_unit=e.Control.extend({ready:function(){this.container.find("input[type=number]").on("change",function(e){var n=t(this),i=parseInt(n.val()),a=n.attr("min")?parseInt(n.attr("min")):1,o=!!n.attr("max")&&parseInt(n.attr("max"));!i||i<a?n.val(a).trigger("change"):!1!==o&&i>o&&n.val(o).trigger("change")})}}),e.controlConstructor.image_id=e.Control.extend({ready:function(){t(this.container).on("click",".fallsky-customize-upload-image, .attachment-thumb",function(e){e.preventDefault(),fallsky_media.open(t(this).parent().siblings("input[type=hidden]").first())}).on("click",".fallsky-customize-remove-image",function(e){e.preventDefault();var n=t(this).parent();t(this).css("display","none"),n.siblings("input[type=hidden]").first().val("").trigger("change"),n.siblings(".placeholder").removeAttr("style"),n.siblings(".thumbnail-image").remove(),n.parent().removeClass("attachment-media-view-image")}).on("fallsky.media.changed","input[type=hidden]",function(e,n){if(e.preventDefault(),n&&"image"==n.type){var i=t(this).closest(".attachment-media-view").addClass("attachment-media-view-image"),a=n.sizes?n.sizes.medium?n.sizes.medium.url:n.sizes.thumbnail?n.sizes.thumbnail.url:n.url:n.url,o=t("<div>",{class:"thumbnail thumbnail-image"}).append(t("<img>",{class:"attachment-thumb",src:a}));i.children(".thumbnail-image").remove(),i.children(".placeholder").css("display","none").after(o),i.find(".fallsky-customize-remove-image").removeAttr("style"),t(this).val(n.id).trigger("change")}})}}),e.controlConstructor.multiple_selection=e.Control.extend({ready:function(){var e=t(this.container).find("select[multiple]");e.length&&e.children('[value=""]').length&&(e.on("change",function(e){var n=t(this).children();n.filter(":selected").length>1&&n.filter('[value=""]').removeAttr("selected")}),e.trigger("change"))}}),e.controlConstructor.mce_editor=e.Control.extend({ready:function(){var e=this.id,n=fallsky_customize&&fallsky_customize.editor_ids&&-1!=fallsky_customize.editor_ids.indexOf(e),i=tinyMCEPreInit&&tinyMCEPreInit.mceInit&&e in tinyMCEPreInit.mceInit&&window.tinymce,a=tinyMCEPreInit&&tinyMCEPreInit.qtInit&&e in tinyMCEPreInit.qtInit&&quicktags;if(n&&i&&a){var o=t(this.container);fallskyInitEditor(e,{mce:tinyMCEPreInit.mceInit[e],qt:tinyMCEPreInit.qtInit[e]},o),window.wpActiveEditor=e}}}),e.controlConstructor.button=e.Control.extend({ready:function(n){e.Control.prototype.ready.apply(this,arguments);var i=fallsky_customize.sync_message||{sending:"Data is syncing. Please wait. It can take a couple of minutes.",done:"Congratulations! Sync is completed.",fail:"Sorry but unable to sync. Please try again later."},a=t(this.container),o=a.find(".customize-control-notifications-container");a.find("input[type=button]").on("click",function(e){e.preventDefault();var n=t(this);o.css("display","none"),n.attr("action")&&n.attr("nonce")&&(n.attr("disabled","disabled"),o.css("display","").children().html("<li>"+i.sending+"</li>"),wp.ajax.post(n.attr("action"),{nonce:n.attr("nonce")}).done(function(e){o.css("display","").children().html("<li>"+i.done+"</li>")}).fail(function(e){o.css("display","").children().html("<li>"+i.fail+"</li>")}).always(function(){n.removeAttr("disabled")}))})}}),e.controlConstructor.group=e.Control.extend({ready:function(){if(this.params.children){var n=this.container.find("ul.group-controls-wrap");t.each(this.params.children,function(i,a){var o=new((e.controlConstructor[a.type]||e.Control).extend({embed:function(){var t,i=this;t=function(t){e.section(t,function(e){e.deferred.embedded.done(function(){n.append(i.container),i.renderContent(),i.deferred.embedded.resolve()})})},i.section.bind(t),t(i.section.get())}}))(i,_.extend({params:a},a));e.fallsky.controls[i]=t.extend({container:o.container},a)})}}}),e.controlConstructor.homepage_widget=e.controlConstructor.widget_form.extend({embed:function(){var n,i=this;n=function(n){n&&e.section(n,function(e){e.deferred.embedded.done(function(){i.params.homepage_area.$controlSection.append(i.container),i.renderContent(),t(i.container).addClass("widget-rendered"),i.deferred.embedded.resolve()})})},i.section.bind(n),n(i.section.get())},getSidebarWidgetsControl:function(){return this.params.homepage_area},_setupRemoveUI:function(){var t,n=this,i=n.container.find(".widget-control-remove");i.on("click",function(e){var t;e.preventDefault(),t=n.container.next().is(".customize-control-widget_form")?n.container.next().find(".widget-action:first"):n.container.prev().is(".customize-control-widget_form")?n.container.prev().find(".widget-action:first"):n.container.next(".customize-control-sidebar_widgets").find(".add-new-widget:first"),n.container.slideUp(function(){var e,i,a=n.params.homepage_area;a&&(e=a.setting().slice(),-1!==(i=_.indexOf(e,n.params.widget_id))&&(e.splice(i,1),a.setting(e),t.focus()))})}),t=function(){i.text(e.Widgets.data.l10n.removeBtnLabel),i.attr("title",e.Widgets.data.l10n.removeBtnTooltip)},this.params.is_new?e.bind("saved",t):t()},onChangeExpanded:function(t,n){var i,a,o,s,r,d,l=this;l.embedWidgetControl(),t&&l.embedWidgetContent(),n.unchanged?t&&e.Control.prototype.expand.call(l,{completeCallback:n.completeCallback}):(i=this.container.find("div.widget:first"),a=i.find(".widget-inside:first"),d=this.container.find(".widget-top button.widget-action"),r=function(){_.each(e.fallsky.homepage_widgets,function(e){e&&l.params.type===e.params.type&&l!==e&&e.collapse()}),o=function(){l.container.removeClass("expanding"),l.container.addClass("expanded"),i.addClass("open"),d.attr("aria-expanded","true"),l.container.trigger("expanded")},n.completeCallback&&(s=o,o=function(){s(),n.completeCallback()}),l.params.is_wide?a.fadeIn(n.duration,o):a.slideDown(n.duration,o),l.container.trigger("expand"),l.container.addClass("expanding")},t?e.section.has(l.section())?e.section(l.section()).expand({completeCallback:r}):r():(o=function(){l.container.removeClass("collapsing"),l.container.removeClass("expanded"),i.removeClass("open"),d.attr("aria-expanded","false"),l.container.trigger("collapsed")},n.completeCallback&&(s=o,o=function(){s(),n.completeCallback()}),l.container.trigger("collapse"),l.container.addClass("collapsing"),l.params.is_wide?a.fadeOut(n.duration,o):a.slideUp(n.duration,function(){i.css({width:"",margin:""}),o()})))}}),e.controlConstructor.homepage_area=e.Widgets.SidebarControl.extend({isReordering:!1,ready:function(){this.$controlSection=this.container.find(".fallsky-homepage-area-wrap"),this.$sectionContent=this.container.find(".fallsky-homepage-area-wrap"),this._addWidgets(),this._setupModel(),this._setupSortable(),this._setupAddition(),this._applyCardinalOrderClassNames()},_addWidgets:function(){var n,i=this;e.fallsky.homepage_area_settings&&e.fallsky.homepage_area_settings[i.id]&&_.each(e.fallsky.homepage_area_settings[i.id],function(a,o){n=new e.controlConstructor.homepage_widget(o,{params:t.extend({},{homepage_area:i},a)}),e.fallsky.homepage_widgets[a.widget_id]=n})},_setupModel:function(){var n=this;this.setting.bind(function(i,o){var s,r,d;r=_(o).difference(i),i=_(i).filter(function(t){var n=a(t);return!!e.Widgets.availableWidgets.findWhere({id_base:n.id_base})}),(s=_(i).map(function(t){var i=e.fallsky.homepage_widgets[t];return i||(i=n.addWidget(t)),i})).sort(function(e,t){return _.indexOf(i,e.params.widget_id)-_.indexOf(i,t.params.widget_id)}),d=0,_(s).each(function(e){e.priority(d),e.section(n.section()),d+=1}),n.priority(d),n._applyCardinalOrderClassNames(),_(s).each(function(e){e.params.sidebar_id=n.params.sidebar_id}),_(r).each(function(i){setTimeout(function(){var o,s,r,d,l=!1;e.each(function(e){if(e.id!==n.setting.id&&0===e.id.indexOf("fallsky_homepage_main_area")){var t=e();-1!==_.indexOf(t,i)&&(l=!0)}}),l||(s=(o=e.fallsky.homepage_widgets[i])&&t.contains(document,o.container[0])&&!t.contains(n.$sectionContent[0],o.container[0]),o&&!s&&(e.fallsky.homepage_widgets[o.id]=!1,o.container.remove()),r=a(i).id_base,(d=e.Widgets.availableWidgets.findWhere({id_base:r}))&&!d.get("is_multi")&&d.set("is_disabled",!1))})})})},_applyCardinalOrderClassNames:function(){var n=[];_.each(this.setting(),function(t){var i=e.fallsky.homepage_widgets[t];i&&n.push(i)}),this.container.find(".reorder-toggle").hide(),n&&n.length&&(t(n).each(function(){t(this.container).removeClass("first-widget last-widget").find(".move-widget-down, .move-widget-up").prop("tabIndex",0)}),_.first(n).container.addClass("first-widget").find(".move-widget-up").prop("tabIndex",-1),_.last(n).container.addClass("last-widget").find(".move-widget-down").prop("tabIndex",-1))},_setupSortable:function(){var e=this;this.isReordering=!1,this.$sectionContent.sortable({items:"> .customize-control-widget_form",handle:".widget-top",axis:"y",tolerance:"pointer",update:function(){var n,i=e.$sectionContent.sortable("toArray");n=t.map(i,function(e){return t("#"+e).find(":input[name=widget-id]").val()}),e.setting(n)}})},getWidgetFormControls:function(){var t=[];return _(this.setting()).each(function(n){var i=e.fallsky.homepage_widgets[n];i&&t.push(i)}),t},addWidget:function(n){var i,o,s,r,d,l,c,g=this,u="widget_form",f=a(n),m=f.number,p=f.id_base,h=e.Widgets.availableWidgets.findWhere({id_base:p});return!!h&&(!(m&&!h.get("is_multi"))&&(h.get("is_multi")&&!m&&(h.set("multi_number",h.get("multi_number")+1),m=h.get("multi_number")),i=t.trim(t("#widget-tpl-"+h.get("id")).html()),h.get("is_multi")?i=i.replace(/<[^<>]+>/g,function(e){return e.replace(/__i__|%i%/g,m)}):h.set("is_disabled",!0),t(i),(o=t("<li/>",{class:"customize-control customize-control-"+u,html:i})).find("> .widget-icon").remove(),h.get("is_multi")&&(o.find('input[name="widget_number"]').val(m),o.find('input[name="multi_number"]').val(m)),n=o.find('[name="widget-id"]').val(),o.hide(),s="widget_"+h.get("id_base"),h.get("is_multi")&&(s+="["+m+"]"),o.attr("id","customize-control-"+s.replace(/\]/g,"").replace(/\[/g,"-")),(r=e.has(s))||(c={transport:e.Widgets.data.selectiveRefreshableWidgets[h.get("id_base")]?"postMessage":"refresh",previewer:this.setting.previewer},e.create(s,s,"",c).set({})),d=new e.controlConstructor.homepage_widget(s,{settings:{default:s},content:o,sidebar_id:g.params.sidebar_id,widget_id:n,widget_id_base:h.get("id_base"),type:u,is_new:!r,width:h.get("width"),height:h.get("height"),is_wide:h.get("is_wide"),homepage_area:g}),e.fallsky.homepage_widgets[n]=d,e.each(function(e){if(e.id!==g.setting.id&&0===e.id.indexOf("fallsky_homepage_main_area")){var t=e().slice(),i=_.indexOf(t,n);-1!==i&&(t.splice(i),e(t))}}),l=this.setting().slice(),-1===_.indexOf(l,n)&&(l.push(n),this.setting(l)),o.slideDown(function(){r&&d.updateWidget({instance:d.setting()})}),d))}}),e.fallsky.site_layout=e.Control.extend({initialize:function(n,i){var a,o=this;o.params={},t.extend(o,i||{}),o.id=n,(a=t.map(o.params.settings,function(e){return e})).length?e.apply(e,a.concat(function(){var t;for(t in o.settings={},o.params.settings)o.settings[t]=e(o.params.settings[t]);o.setting=o.settings.default||null})):(o.setting=null,o.settings={}),o.ready()},ready:function(){var t=this;t.setting&&(t.setting.bind(function(e){t.settingChanged(e,t)}),t.settingChanged(t.setting(),t),e.trigger("fallsky.change",t.id))},settingChanged:function(e,n){e in fallsky_customize&&t.each(fallsky_customize[e],function(e,t){n.updateControlTitle(e,t)})},updateControlTitle:function(n,i){var a=e.control(n),o=!!a&&t(a.container);if(o&&a.params.type)switch(a.params.type){case"title_only":o.find("h3").text(i);break;case"checkbox":var s=o.children("label");s.length&&s.text(i);break;default:var r=o.find(".customize-control-title");r.length&&r.text(i)}}}),e.bind("ready",function(a){var o=t("#available-widgets-list"),s=t('div[data-widget-id^="fallsky-homepage-widget"]'),r=t(".customize-control-sidebar_widgets .button-link.reorder-toggle");t("#customize-control-header_image .customizer-section-intro").html(fallsky_customize.header_description),t("#customize-control-header_image .current .customize-control-title").html(fallsky_customize.header_label),i(),n in e.settings.controls&&new e.fallsky.site_layout(n,{params:e.settings.controls[n]}),s.length&&r.length&&r.remove(),t("#customize-theme-controls").on("click",".customize-control-sidebar_widgets .button.add-new-widget, .customize-control.customize-control-homepage_area .button.add-new-widget",function(e){o.length&&s.length&&(t(this).closest(".control-section-sidebar").length?o.children().not(s.addClass("hide")).removeClass("hide"):o.children().not(s.removeClass("hide")).addClass("hide"))}),e("show_on_front","page_on_front","page_for_posts","fallsky_category_index_page_id",function(t,n,i,a){var o=function(){var o,s,r,d="category_index_page_collision";o=parseInt(n(),10),s=parseInt(i(),10),r=parseInt(a(),10);var l=[o,s];"page"===t()&&r&&(o||s)&&-1!=l.indexOf(r)?a.notifications.add(new e.Notification(d,{type:"error",message:fallsky_customize.category_index_error_message})):(a.notifications.remove(d),this===a&&r>0&&e.previewer.previewUrl.set(e.settings.url.home+"?page_id="+r))};t.bind(o),n.bind(o),i.bind(o),a.bind(o),o.call(t)}),t("body").on("click","a.show-control",function(n){n.preventDefault();var i=t(this).data("control-id");i&&e.previewer.trigger("focus-control-for-setting",i)}).on("click","a.show-panel, a.show-section",function(e){e.preventDefault();var n=t(this).data("section-id");n&&t("#"+n).length&&t("#"+n).find(".accordion-section-title").trigger("click")}).on("click","a.redirect-preview-url",function(n){n.preventDefault();var i=t(this).attr("href");if(t(this).hasClass("static-home")){var a=!!e.get().page_for_posts&&e.get().page_for_posts;i=a?"?page_id="+a:""}i&&"#"!=i&&e.previewer.previewUrl.set(e.settings.url.home+i)})})}(wp.customize,jQuery);