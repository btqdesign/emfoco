!function(m,p){"use strict";p("#customize-theme-controls").addClass("fallsky-customizer-wrapper"),m.fallsky=m.fallsky||{},m.fallsky.controls=m.fallsky.controls||{},m.fallsky.homepage_widgets=m.fallsky.homepage_widgets||{},m.fallsky.homepage_area_settings=fallsky_customize.homepage_area_settings||!1;var a="fallsky_site_layout";function o(){var s=m.settings.settings,r={},e=p.extend({},m.settings.controls,m.fallsky.controls);p.each(e,function(i,a){var e,t,n,o=(e=a.settings,t=Object.keys(e),!!(n="default"in e?"default":!!t.length&&t[0])&&e[n]);o&&s[o]&&s[o].dependency&&p.each(s[o].dependency,function(t,e){var n={control:m.control(i)||a,dependency:s[o].dependency};t in r?r[t].push(n):(r[t]=[n],m(t).bind(function(e){m.trigger("fallsky.change",t)}))})}),m.fallsky.dependency=r}function h(e){var t,n={number:null,id_base:null};return(t=e.match(/^(.+)-(\d+)$/))?(n.id_base=t[1],n.number=parseInt(t[2],10)):n.id_base=e,n}m.bind("fallsky.change",function(e){e in m.fallsky.dependency&&p.each(m.fallsky.dependency[e],function(e,t){var n=t.control.container,a=!0;p.each(t.dependency,function(e,t){var n=t.operator||"in",i=function(e){if(e in m.settings.settings){var t=m.get()[e];return!0===t?"on":t}}(e);if("in"===n&&-1===t.value.indexOf(i)||"not in"===n&&-1!==t.value.indexOf(i))return a=!1}),a?n.show():n.hide()})}),m.controlConstructor.number_slider=m.Control.extend({ready:function(){var e=this.container.find(".loader-ui-slider"),n=this.container.find("input[data-customize-setting-link]");e.slider({range:"min",min:e.data("min"),max:e.data("max"),value:e.data("value"),step:e.data("step"),slide:function(e,t){n.val(t.value).trigger("change")}})}}),m.controlConstructor.number=m.controlConstructor.number_with_unit=m.Control.extend({ready:function(){this.container.find("input[type=number]").on("change",function(e){var t=p(this),n=parseInt(t.val()),i=t.attr("min")?parseInt(t.attr("min")):1,a=!!t.attr("max")&&parseInt(t.attr("max"));!n||n<i?t.val(i).trigger("change"):!1!==a&&a<n&&t.val(a).trigger("change")})}}),m.controlConstructor.image_id=m.Control.extend({ready:function(){p(this.container).on("click",".fallsky-customize-upload-image, .attachment-thumb",function(e){e.preventDefault(),fallsky_media.open(p(this).parent().siblings("input[type=hidden]").first())}).on("click",".fallsky-customize-remove-image",function(e){e.preventDefault();var t=p(this).parent();p(this).css("display","none"),t.siblings("input[type=hidden]").first().val("").trigger("change"),t.siblings(".placeholder").removeAttr("style"),t.siblings(".thumbnail-image").remove(),t.parent().removeClass("attachment-media-view-image")}).on("fallsky.media.changed","input[type=hidden]",function(e,t){if(e.preventDefault(),t&&"image"==t.type){var n=p(this).closest(".attachment-media-view").addClass("attachment-media-view-image"),i=t.sizes?t.sizes.medium?t.sizes.medium.url:t.sizes.thumbnail?t.sizes.thumbnail.url:t.url:t.url,a=p("<div>",{class:"thumbnail thumbnail-image"}).append(p("<img>",{class:"attachment-thumb",src:i}));n.children(".thumbnail-image").remove(),n.children(".placeholder").css("display","none").after(a),n.find(".fallsky-customize-remove-image").removeAttr("style"),p(this).val(t.id).trigger("change")}})}}),m.controlConstructor.multiple_selection=m.Control.extend({ready:function(){var e=p(this.container).find("select[multiple]");e.length&&e.children('[value=""]').length&&(e.on("change",function(e){var t=p(this).children();1<t.filter(":selected").length&&t.filter('[value=""]').removeAttr("selected")}),e.trigger("change"))}}),m.controlConstructor.mce_editor=m.Control.extend({ready:function(){var e=this.id,t=fallsky_customize&&fallsky_customize.editor_ids&&-1!=fallsky_customize.editor_ids.indexOf(e),n=tinyMCEPreInit&&tinyMCEPreInit.mceInit&&e in tinyMCEPreInit.mceInit&&window.tinymce,i=tinyMCEPreInit&&tinyMCEPreInit.qtInit&&e in tinyMCEPreInit.qtInit&&quicktags;if(t&&n&&i){var a=p(this.container);fallskyInitEditor(e,{mce:tinyMCEPreInit.mceInit[e],qt:tinyMCEPreInit.qtInit[e]},a),window.wpActiveEditor=e}}}),m.controlConstructor.button=m.Control.extend({ready:function(e){m.Control.prototype.ready.apply(this,arguments);var n=fallsky_customize.sync_message||{sending:"Data is syncing. Please wait. It can take a couple of minutes.",done:"Congratulations! Sync is completed.",fail:"Sorry but unable to sync. Please try again later."},t=p(this.container),i=t.find(".customize-control-notifications-container");t.find("input[type=button]").on("click",function(e){e.preventDefault();var t=p(this);i.css("display","none"),t.attr("action")&&t.attr("nonce")&&(t.attr("disabled","disabled"),i.css("display","").children().html("<li>"+n.sending+"</li>"),wp.ajax.post(t.attr("action"),{nonce:t.attr("nonce")}).done(function(e){i.css("display","").children().html("<li>"+n.done+"</li>")}).fail(function(e){i.css("display","").children().html("<li>"+n.fail+"</li>")}).always(function(){t.removeAttr("disabled")}))})}}),m.controlConstructor.group=m.Control.extend({ready:function(){if(this.params.children){var i=this.container.find("ul.group-controls-wrap");p.each(this.params.children,function(e,t){var n=new((m.controlConstructor[t.type]||m.Control).extend({embed:function(){var e,t=this;e=function(e){m.section(e,function(e){e.deferred.embedded.done(function(){i.append(t.container),t.renderContent(),t.deferred.embedded.resolve()})})},t.section.bind(e),e(t.section.get())}}))(e,_.extend({params:t},t));m.fallsky.controls[e]=p.extend({container:n.container},t)})}}}),m.controlConstructor.homepage_widget=m.controlConstructor.widget_form.extend({embed:function(){var e,t=this;e=function(e){e&&m.section(e,function(e){e.deferred.embedded.done(function(){t.params.homepage_area.$controlSection.append(t.container),t.renderContent(),p(t.container).addClass("widget-rendered"),t.deferred.embedded.resolve()})})},t.section.bind(e),e(t.section.get())},getSidebarWidgetsControl:function(){return this.params.homepage_area},_setupRemoveUI:function(){var e,a=this,t=a.container.find(".widget-control-remove");t.on("click",function(e){var i;e.preventDefault(),i=a.container.next().is(".customize-control-widget_form")?a.container.next().find(".widget-action:first"):a.container.prev().is(".customize-control-widget_form")?a.container.prev().find(".widget-action:first"):a.container.next(".customize-control-sidebar_widgets").find(".add-new-widget:first"),a.container.slideUp(function(){var e,t,n=a.params.homepage_area;n&&(e=n.setting().slice(),-1!==(t=_.indexOf(e,a.params.widget_id))&&(e.splice(t,1),n.setting(e),i.focus()))})}),e=function(){t.text(m.Widgets.data.l10n.removeBtnLabel),t.attr("title",m.Widgets.data.l10n.removeBtnTooltip)},this.params.is_new?m.bind("saved",e):e()},onChangeExpanded:function(e,t){var n,i,a,o,s,r,l=this;l.embedWidgetControl(),e&&l.embedWidgetContent(),t.unchanged?e&&m.Control.prototype.expand.call(l,{completeCallback:t.completeCallback}):(n=this.container.find("div.widget:first"),i=n.find(".widget-inside:first"),r=this.container.find(".widget-top button.widget-action"),s=function(){_.each(m.fallsky.homepage_widgets,function(e){e&&l.params.type===e.params.type&&l!==e&&e.collapse()}),a=function(){l.container.removeClass("expanding"),l.container.addClass("expanded"),n.addClass("open"),r.attr("aria-expanded","true"),l.container.trigger("expanded")},t.completeCallback&&(o=a,a=function(){o(),t.completeCallback()}),l.params.is_wide?i.fadeIn(t.duration,a):i.slideDown(t.duration,a),l.container.trigger("expand"),l.container.addClass("expanding")},e?m.section.has(l.section())?m.section(l.section()).expand({completeCallback:s}):s():(a=function(){l.container.removeClass("collapsing"),l.container.removeClass("expanded"),n.removeClass("open"),r.attr("aria-expanded","false"),l.container.trigger("collapsed")},t.completeCallback&&(o=a,a=function(){o(),t.completeCallback()}),l.container.trigger("collapse"),l.container.addClass("collapsing"),l.params.is_wide?i.fadeOut(t.duration,a):i.slideUp(t.duration,function(){n.css({width:"",margin:""}),a()})))}}),m.controlConstructor.homepage_area=m.Widgets.SidebarControl.extend({isReordering:!1,ready:function(){this.$controlSection=this.container.find(".fallsky-homepage-area-wrap"),this.$sectionContent=this.container.find(".fallsky-homepage-area-wrap"),this._addWidgets(),this._setupModel(),this._setupSortable(),this._setupAddition(),this._applyCardinalOrderClassNames()},_addWidgets:function(){var n,i=this;m.fallsky.homepage_area_settings&&m.fallsky.homepage_area_settings[i.id]&&_.each(m.fallsky.homepage_area_settings[i.id],function(e,t){n=new m.controlConstructor.homepage_widget(t,{params:p.extend({},{homepage_area:i},e)}),m.fallsky.homepage_widgets[e.widget_id]=n})},_setupModel:function(){var s=this;this.setting.bind(function(n,e){var t,i,a;i=_(e).difference(n),n=_(n).filter(function(e){var t=h(e);return!!m.Widgets.availableWidgets.findWhere({id_base:t.id_base})}),(t=_(n).map(function(e){var t=m.fallsky.homepage_widgets[e];return t||(t=s.addWidget(e)),t})).sort(function(e,t){return _.indexOf(n,e.params.widget_id)-_.indexOf(n,t.params.widget_id)}),a=0,_(t).each(function(e){e.priority(a),e.section(s.section()),a+=1}),s.priority(a),s._applyCardinalOrderClassNames(),_(t).each(function(e){e.params.sidebar_id=s.params.sidebar_id}),_(i).each(function(o){setTimeout(function(){var e,t,n,i,a=!1;m.each(function(e){if(e.id!==s.setting.id&&0===e.id.indexOf("fallsky_homepage_main_area")){var t=e();-1!==_.indexOf(t,o)&&(a=!0)}}),a||(t=(e=m.fallsky.homepage_widgets[o])&&p.contains(document,e.container[0])&&!p.contains(s.$sectionContent[0],e.container[0]),e&&!t&&(m.fallsky.homepage_widgets[e.id]=!1,e.container.remove()),n=h(o).id_base,(i=m.Widgets.availableWidgets.findWhere({id_base:n}))&&!i.get("is_multi")&&i.set("is_disabled",!1))})})})},_applyCardinalOrderClassNames:function(){var n=[];_.each(this.setting(),function(e){var t=m.fallsky.homepage_widgets[e];t&&n.push(t)}),this.container.find(".reorder-toggle").hide(),n&&n.length&&(p(n).each(function(){p(this.container).removeClass("first-widget last-widget").find(".move-widget-down, .move-widget-up").prop("tabIndex",0)}),_.first(n).container.addClass("first-widget").find(".move-widget-up").prop("tabIndex",-1),_.last(n).container.addClass("last-widget").find(".move-widget-down").prop("tabIndex",-1))},_setupSortable:function(){var n=this;this.isReordering=!1,this.$sectionContent.sortable({items:"> .customize-control-widget_form",handle:".widget-top",axis:"y",tolerance:"pointer",update:function(){var e,t=n.$sectionContent.sortable("toArray");e=p.map(t,function(e){return p("#"+e).find(":input[name=widget-id]").val()}),n.setting(e)}})},getWidgetFormControls:function(){var n=[];return _(this.setting()).each(function(e){var t=m.fallsky.homepage_widgets[e];t&&n.push(t)}),n},addWidget:function(i){var e,t,n,a,o,s,r,l=this,d="widget_form",c=h(i),g=c.number,u=c.id_base,f=m.Widgets.availableWidgets.findWhere({id_base:u});return!!f&&(!(g&&!f.get("is_multi"))&&(f.get("is_multi")&&!g&&(f.set("multi_number",f.get("multi_number")+1),g=f.get("multi_number")),e=p.trim(p("#widget-tpl-"+f.get("id")).html()),f.get("is_multi")?e=e.replace(/<[^<>]+>/g,function(e){return e.replace(/__i__|%i%/g,g)}):f.set("is_disabled",!0),p(e),(t=p("<li/>",{class:"customize-control customize-control-"+d,html:e})).find("> .widget-icon").remove(),f.get("is_multi")&&(t.find('input[name="widget_number"]').val(g),t.find('input[name="multi_number"]').val(g)),i=t.find('[name="widget-id"]').val(),t.hide(),n="widget_"+f.get("id_base"),f.get("is_multi")&&(n+="["+g+"]"),t.attr("id","customize-control-"+n.replace(/\]/g,"").replace(/\[/g,"-")),(a=m.has(n))||(r={transport:m.Widgets.data.selectiveRefreshableWidgets[f.get("id_base")]?"postMessage":"refresh",previewer:this.setting.previewer},m.create(n,n,"",r).set({})),o=new m.controlConstructor.homepage_widget(n,{settings:{default:n},content:t,sidebar_id:l.params.sidebar_id,widget_id:i,widget_id_base:f.get("id_base"),type:d,is_new:!a,width:f.get("width"),height:f.get("height"),is_wide:f.get("is_wide"),homepage_area:l}),m.fallsky.homepage_widgets[i]=o,m.each(function(e){if(e.id!==l.setting.id&&0===e.id.indexOf("fallsky_homepage_main_area")){var t=e().slice(),n=_.indexOf(t,i);-1!==n&&(t.splice(n),e(t))}}),s=this.setting().slice(),-1===_.indexOf(s,i)&&(s.push(i),this.setting(s)),t.slideDown(function(){a&&o.updateWidget({instance:o.setting()})}),o))}}),m.fallsky.site_layout=m.Control.extend({initialize:function(e,t){var n,i=this;i.params={},p.extend(i,t||{}),i.id=e,(n=p.map(i.params.settings,function(e){return e})).length?m.apply(m,n.concat(function(){var e;for(e in i.settings={},i.params.settings)i.settings[e]=m(i.params.settings[e]);i.setting=i.settings.default||null})):(i.setting=null,i.settings={}),i.ready()},ready:function(){var t=this;t.setting&&(t.setting.bind(function(e){t.settingChanged(e,t)}),t.settingChanged(t.setting(),t),m.trigger("fallsky.change",t.id))},settingChanged:function(e,n){e in fallsky_customize&&p.each(fallsky_customize[e],function(e,t){n.updateControlTitle(e,t)})},updateControlTitle:function(e,t){var n=m.control(e),i=!!n&&p(n.container);if(i&&n.params.type)switch(n.params.type){case"title_only":i.find("h3").text(t);break;case"checkbox":var a=i.children("label");a.length&&a.text(t);break;default:var o=i.find(".customize-control-title");o.length&&o.text(t)}}}),m.bind("ready",function(e){var t=p("#available-widgets-list"),n=p('div[data-widget-id^="fallsky-homepage-widget"]'),i=p(".customize-control-sidebar_widgets .button-link.reorder-toggle");p("#customize-control-header_image .customizer-section-intro").html(fallsky_customize.header_description),p("#customize-control-header_image .current .customize-control-title").html(fallsky_customize.header_label),o(),a in m.settings.controls&&new m.fallsky.site_layout(a,{params:m.settings.controls[a]}),n.length&&i.length&&i.remove(),p("#customize-theme-controls").on("click",".customize-control-sidebar_widgets .button.add-new-widget, .customize-control.customize-control-homepage_area .button.add-new-widget",function(e){t.length&&n.length&&(p(this).closest(".control-section-sidebar").length?t.children().not(n.addClass("hide")).removeClass("hide"):t.children().not(n.removeClass("hide")).addClass("hide"))}),m("show_on_front","page_on_front","page_for_posts","fallsky_category_index_page_id",function(o,s,r,l){var e=function(){var e,t,n,i="category_index_page_collision";e=parseInt(s(),10),t=parseInt(r(),10),n=parseInt(l(),10);var a=[e,t];"page"===o()&&n&&(e||t)&&-1!=a.indexOf(n)?l.notifications.add(new m.Notification(i,{type:"error",message:fallsky_customize.category_index_error_message})):(l.notifications.remove(i),this===l&&0<n&&m.previewer.previewUrl.set(m.settings.url.home+"?page_id="+n))};o.bind(e),s.bind(e),r.bind(e),l.bind(e),e.call(o)}),p("body").on("click","a.show-control",function(e){e.preventDefault();var t=p(this).data("control-id");t&&m.previewer.trigger("focus-control-for-setting",t)}).on("click","a.show-panel, a.show-section",function(e){e.preventDefault();var t=p(this).data("section-id");t&&p("#"+t).length&&p("#"+t).find(".accordion-section-title").trigger("click")}).on("click","a.redirect-preview-url",function(e){e.preventDefault();var t=p(this).attr("href");if(p(this).hasClass("static-home")){var n=!!m.get().page_for_posts&&m.get().page_for_posts;t=n?"?page_id="+n:""}t&&"#"!=t&&m.previewer.previewUrl.set(m.settings.url.home+t)}).on("click","#customize-control-fallsky_instagram_clear_cache input[type=button]",function(e){if(e.preventDefault(),wpApiSettings&&wpApiSettings.root){var t=p(this);t.val(fallsky_customize["clear-instagram-cache"].sending).attr("disabled","disabled");var n=wpApiSettings.root+"loftocean/v1/clear-instagram-cache/";p.get(n).done(function(){t.val(fallsky_customize["clear-instagram-cache"].done).removeAttr("disabled")})}})})}(wp.customize,jQuery);